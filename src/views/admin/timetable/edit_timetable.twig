{% extends '@admin/timetable/layout.twig' %}

{% set activeTab = '' %}

{% block timetableTitle %}Edytuj plan lekcji klasy {{ class.displayName }}{% endblock %}

{% block timetableContent %}
    <table class="table mb-4 lessonsTable">
        <thead>
        <tr>
            <th></th>
            <th></th>
            <th>Poniedziałek</th>
            <th>Wtorek</th>
            <th>Środa</th>
            <th>Czwartek</th>
            <th>Piątek</th>
        </tr>
        </thead>
        <tbody>
        {% for hour in lessonHours %}
            <tr>
                <th scope="row">{{ hour.id }}</th>
                <th scope="row">{{ hour.startsAt|date('H:i') }} - {{ hour.endsAt|date('H:i') }}</th>
                {% for day in 1..5 %}
                    {% set lesson = class.mappedLessons[day][hour.id] %}
                    {% if lesson is not null %}
                        <td>
                            <div class="d-flex">
                                {{ lesson.subject.name }}
                                <a href="#" class="text-info ml-auto">e</a>
                                <a href="#" class="text-danger ml-1 deleteLessonLink" data-toggle="modal" data-target="#deleteLessonModal"
                                   data-url="{{ path('admin.timetable.deleteLessonSubject', {class: class.name, day: day, lessonHour: hour.id}) }}"
                                   data-hour="{{ hour.id }}" data-subject="{{ lesson.subject.name }}">&times;</a>
                            </div>
                        </td>
                    {% else %}
                        <td>
                            <div class="d-flex justify-content-end">
                                <a href="#" class="text-success">+</a>
                            </div>
                        </td>
                    {% endif %}
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endblock %}

{% block scripts %}
    {{ parent() }}
    <div class="modal" tabindex="-1" id="deleteLessonModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Usuwanie przedmiotu z lekcji</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="deleteLessonModal-body" class="mb-0">Czy na pewno chcesz usunąć przedmiot Matematyka z 1. lekcji?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="deleteLessonModal-delete">Usuń przedmiot</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Zamknij</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        $('#deleteLessonModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);

            var url = button.data('url');
            var hour = button.data('hour');
            var subject = button.data('subject');

            $('#deleteLessonModal-body').text('Czy na pewno chcesz usunąć przedmiot ' + subject + ' z ' + hour + '. lekcji?');

            $('#deleteLessonModal-delete').attr('data-url', url);
        });

        $('#deleteLessonModal-delete').on('click', function (event) {
            var button = $(this);
            var url = button.data('url');

            $.ajax({
                url: url,
                type: 'DELETE',
                success: function () {
                    $('#deleteLessonModal').modal('hide');

                    // Empty cell
                    $('a[data-url="' + url + '"]').closest('td').html('\n' +
                        '<div class="d-flex justify-content-end">\n' +
                        '    <a href="#" class="text-success">+</a>\n' +
                        '</div>');
                },
                error: function (response) {
                    alert('Błąd usuwania!');
                    console.error('Błąd usuwania', response);
                }
            });
        });
    </script>
{% endblock %}
